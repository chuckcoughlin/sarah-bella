#!/bin/sh

### BEGIN INIT INFO
# Provides:          ros
# Required-Start:    $local_fs $remote_fs dbus
# Required-Stop:     $local_fs $remote_fs dbus
# Should-Start:      $named
# Should-Stop:       $named
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start roscore
### END INIT INFO

set -e

PATH=/opt/ros/kinetic/bin:/bin:/usr/bin:/sbin:/usr/sbin
DAEMON=/opt/ros/kinetic/bin/roscore
export ROSLOG=/var/log/ros.log

test -x $DAEMON || exit 0

. /lib/lsb/init-functions
# NOTE: HOME is the sudoer home directory
export HOME=/home/chuckc
export ROS_ROOT=/opt/ros/kinetic/share/ros
export ROS_PACKAGE_PATH=${HOME}/robotics/catkin_ws/src:/opt/ros/kineetic/share
export ROS_MASTER_URI=http://localhost:11311
export ROS_ETC_DIR=/opt/ros/kinetic/etc/ros
export PYTHONPATH=${HOME}/robotics/catkin_ws/devel/lib/python2.7/dist-packages:/opt/ros/kinetic/lib/python2.7/dist-packages

case "$1" in
  start)
	. /opt/ros/kinetic/setup.sh
	. ${HOME}/robotics/repo/robot/config/launch.conf
	env
	> $ROSLOG
	# This is important. You must wait until the IP address of the machine
	# is actually configured. Otherwise, you will get an error and launch
	# will fail. Loop until the IP comes up. 
 	while true; do
          IP="`ifconfig | grep 'inet addr:192.168.'| cut -d: -f2 | awk '{ print $1}'`"
          IP="`ifconfig | grep 'inet addr:10.0.'| cut -d: -f2 | awk '{ print $1}'`"

        if [ "$IP" ] ; then
                echo "Found: IP = ${IP}"
                break
        fi
	sleep 1
  	done

	echo "=============================== /etc/init.d/ros start ===========================" >> ${ROSLOG}
	roslaunch ${LAUNCH_PKG} ${LAUNCH_FILE} >>${ROSLOG} 2>&1
	echo "=============================== /etc/init.d/ros exited ===========================" >> ${ROSLOG}
  ;;

  restart)
    /etc/init.d/ros stop
    /etc/init.d/ros start
  ;;

  stop)
	. /opt/ros/kinetic/setup.sh
	for i in $(rosnode list) ; do
		rosnode kil $i
	done
  	killall roscore
  ;;
  force-reload)
    /etc/init.d/ros restart
  ;;

  *)
    echo "Usage: /etc/init.d/ros {start|stop|restart|force-reload}"
    exit 1
    ;;
esac


